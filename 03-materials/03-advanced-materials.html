<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js 高级材质示例</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 350px;
        }
        #info h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #4CAF50;
        }
        #info p {
            margin: 5px 0;
            line-height: 1.5;
        }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            width: 280px;
            max-height: 80vh;
            overflow-y: auto;
        }
        #controls h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #4CAF50;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .control-group input[type="range"] {
            width: 100%;
        }
        .material-label {
            position: absolute;
            color: white;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="info">
        <h2>高级材质示例</h2>
        <p>展示MeshPhysicalMaterial的高级特性</p>
        <p>从左到右：</p>
        <p>1. 清漆涂层 - clearcoat</p>
        <p>2. 玻璃材质 - transmission</p>
        <p>3. 绒布材质 - sheen</p>
        <p>4. 彩虹效果 - iridescence</p>
        <p>5. 各向异性 - anisotropy</p>
    </div>

    <div id="controls">
        <h3>材质控制</h3>
        <div class="control-group">
            <label>清漆强度 (Clearcoat): <span id="clearcoatValue">0</span></label>
            <input type="range" id="clearcoat" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="control-group">
            <label>清漆粗糙度 (Clearcoat Roughness): <span id="clearcoatRoughnessValue">0</span></label>
            <input type="range" id="clearcoatRoughness" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="control-group">
            <label>透射率 (Transmission): <span id="transmissionValue">0</span></label>
            <input type="range" id="transmission" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="control-group">
            <label>厚度 (Thickness): <span id="thicknessValue">0</span></label>
            <input type="range" id="thickness" min="0" max="2" step="0.01" value="0">
        </div>
        <div class="control-group">
            <label>折射率 (IOR): <span id="iorValue">1.5</span></label>
            <input type="range" id="ior" min="1" max="2.333" step="0.001" value="1.5">
        </div>
        <div class="control-group">
            <label>绒布强度 (Sheen): <span id="sheenValue">0</span></label>
            <input type="range" id="sheen" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="control-group">
            <label>彩虹强度 (Iridescence): <span id="iridescenceValue">0</span></label>
            <input type="range" id="iridescence" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="control-group">
            <label>各向异性 (Anisotropy): <span id="anisotropyValue">0</span></label>
            <input type="range" id="anisotropy" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="control-group">
            <label>各向异性旋转 (Anisotropy Rotation): <span id="anisotropyRotationValue">0</span></label>
            <input type="range" id="anisotropyRotation" min="0" max="1" step="0.01" value="0">
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        // 导入Three.js核心库和轨道控制器
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 全局变量声明
        let scene, camera, renderer, controls;  // 场景、相机、渲染器、控制器
        let spheres = [];  // 存储所有球体网格对象
        let currentMaterial;  // 当前选中的材质

        /**
         * 初始化函数
         * 创建场景、相机、渲染器等基础组件
         */
        function init() {
            // 创建容器div并添加到body
            const container = document.createElement('div');
            document.body.appendChild(container);

            // 创建场景对象
            scene = new THREE.Scene();
            // 设置场景背景颜色为深灰色
            scene.background = new THREE.Color(0x222222);

            // 创建透视相机
            // 参数: 视野角度(60度), 宽高比, 近裁剪面(0.1), 远裁剪面(1000)
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            // 设置相机位置
            camera.position.set(0, 4, 10);

            // 创建WebGL渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });  // 开启抗锯齿
            renderer.setSize(window.innerWidth, window.innerHeight);  // 设置渲染尺寸
            renderer.setPixelRatio(window.devicePixelRatio);  // 设置像素比，适配高清屏
            renderer.shadowMap.enabled = true;  // 启用阴影映射
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;  // 使用柔和阴影
            renderer.toneMapping = THREE.ACESFilmicToneMapping;  // 使用ACES电影级色调映射
            renderer.toneMappingExposure = 1.0;  // 设置曝光度
            container.appendChild(renderer.domElement);  // 将渲染器添加到容器

            // 创建轨道控制器
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;  // 启用阻尼效果，使旋转更平滑
            controls.dampingFactor = 0.05;  // 阻尼系数

            // 添加光源
            addLights();
            // 创建环境光照
            createEnvironment();
            // 创建高级材质球体
            createMaterials();
            // 创建地面
            createFloor();
            // 创建标签
            createLabels();
            // 设置控制面板
            setupControls();

            // 监听窗口大小变化
            window.addEventListener('resize', onWindowResize);
            // 开始动画循环
            animate();
        }

        /**
         * 添加光源
         * 创建环境光、平行光和多个彩色点光源
         */
        function addLights() {
            // 创建环境光 - 提供基础照明，强度较低
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            scene.add(ambientLight);

            // 创建平行光 - 模拟太阳光，可投射阴影
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7);  // 设置光源位置
            directionalLight.castShadow = true;  // 启用阴影投射
            directionalLight.shadow.mapSize.width = 1024;  // 阴影贴图宽度
            directionalLight.shadow.mapSize.height = 1024;  // 阴影贴图高度
            scene.add(directionalLight);

            // 创建橙色点光源 - 增加场景色彩
            const pointLight1 = new THREE.PointLight(0xff6600, 2, 20);
            pointLight1.position.set(-5, 5, 5);  // 设置光源位置
            scene.add(pointLight1);

            // 创建蓝色点光源 - 增加场景色彩
            const pointLight2 = new THREE.PointLight(0x0066ff, 2, 20);
            pointLight2.position.set(5, 5, -5);  // 设置光源位置
            scene.add(pointLight2);

            // 创建紫色点光源 - 增加场景色彩
            const pointLight3 = new THREE.PointLight(0xff00ff, 1, 20);
            pointLight3.position.set(0, 8, 0);  // 设置光源位置
            scene.add(pointLight3);
        }

        /**
         * 创建环境光照
         * 使用PMREM生成器创建环境贴图
         */
        function createEnvironment() {
            // 创建PMREM生成器 - 用于预过滤环境贴图
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            pmremGenerator.compileEquirectangularShader();  // 编译着色器

            // 创建临时场景用于生成环境贴图
            const sceneEnv = new THREE.Scene();
            sceneEnv.background = new THREE.Color(0x888888);  // 灰色环境

            // 从场景生成环境贴图
            const envTexture = pmremGenerator.fromScene(sceneEnv).texture;
            scene.environment = envTexture;  // 设置场景环境贴图
            scene.background = envTexture;  // 设置场景背景

            // 清理PMREM生成器资源
            pmremGenerator.dispose();
        }

        /**
         * 创建高级材质球体
         * 展示MeshPhysicalMaterial的高级特性
         */
        function createMaterials() {
            // 创建球体几何体 - 使用高分段数以获得更平滑的表面
            // 参数: 半径(0.7), 水平分段数(64), 垂直分段数(64)
            const geometry = new THREE.SphereGeometry(0.7, 64, 64);

            // 定义5种高级材质及其配置
            const materials = [
                {
                    name: '清漆涂层',
                    // MeshPhysicalMaterial - 物理材质，支持高级特性
                    material: new THREE.MeshPhysicalMaterial({
                        color: 0xff0000,  // 红色
                        roughness: 0.3,  // 基础粗糙度
                        metalness: 0.7,  // 金属度
                        clearcoat: 1.0,  // 清漆强度：1.0表示完全清漆
                        clearcoatRoughness: 0.1  // 清漆粗糙度：0.1表示光滑的清漆
                    }),
                    position: { x: -4, y: 1, z: 0 }
                },
                {
                    name: '玻璃材质',
                    material: new THREE.MeshPhysicalMaterial({
                        color: 0xffffff,  // 白色
                        roughness: 0,  // 完全光滑
                        metalness: 0,  // 非金属
                        transmission: 1.0,  // 透射率：1.0表示完全透明
                        thickness: 0.5,  // 玻璃厚度
                        ior: 1.5  // 折射率：1.5是常见玻璃折射率
                    }),
                    position: { x: -2, y: 1, z: 0 }
                },
                {
                    name: '绒布材质',
                    material: new THREE.MeshPhysicalMaterial({
                        color: 0x00ff00,  // 绿色
                        roughness: 0.8,  // 表面粗糙
                        metalness: 0,  // 非金属
                        sheen: 1.0,  // 绒布强度：1.0表示强绒布效果
                        sheenRoughness: 0.5,  // 绒布粗糙度
                        sheenColor: new THREE.Color(0xffffff)  // 绒布颜色
                    }),
                    position: { x: 0, y: 1, z: 0 }
                },
                {
                    name: '彩虹效果',
                    material: new THREE.MeshPhysicalMaterial({
                        color: 0x0000ff,  // 蓝色
                        roughness: 0.2,  // 表面光滑
                        metalness: 0.8,  // 高金属度
                        iridescence: 1.0,  // 彩虹强度：1.0表示强彩虹效果
                        iridescenceIOR: 1.3,  // 彩虹折射率
                        iridescenceThicknessRange: [100, 400]  // 彩虹厚度范围(纳米)
                    }),
                    position: { x: 2, y: 1, z: 0 }
                },
                {
                    name: '各向异性',
                    material: new THREE.MeshPhysicalMaterial({
                        color: 0xffff00,  // 黄色
                        roughness: 0.3,  // 中等粗糙度
                        metalness: 0.9,  // 高金属度
                        anisotropy: 1.0,  // 各向异性强度：1.0表示强各向异性
                        anisotropyRotation: 0  // 各向异性旋转角度
                    }),
                    position: { x: 4, y: 1, z: 0 }
                }
            ];

            // 遍历材质数组，创建球体网格
            materials.forEach((item, index) => {
                const sphere = new THREE.Mesh(geometry, item.material);
                sphere.position.set(item.position.x, item.position.y, item.position.z);
                sphere.castShadow = true;  // 投射阴影
                sphere.receiveShadow = true;  // 接收阴影
                sphere.userData.name = item.name;  // 存储材质名称
                sphere.userData.originalMaterial = item.material;  // 存储原始材质
                scene.add(sphere);
                spheres.push(sphere);  // 添加到球体数组
            });

            // 默认选中第一个球体（清漆涂层）
            currentMaterial = spheres[0].material;
        }

        /**
         * 创建地面
         * 创建接收阴影的地面和网格辅助线
         */
        function createFloor() {
            // 创建平面几何体
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            // 创建标准材质
            const floorMaterial = new THREE.MeshStandardMaterial({
                color: 0x444444,  // 深灰色
                roughness: 0.8,  // 粗糙度
                metalness: 0.2  // 金属度
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;  // 旋转90度使其水平
            floor.position.y = 0;  // 设置地面高度
            floor.receiveShadow = true;  // 接收阴影
            scene.add(floor);

            // 创建网格辅助线
            const gridHelper = new THREE.GridHelper(20, 20, 0x666666, 0x555555);
            gridHelper.position.y = 0.01;  // 稍微抬高避免z-fighting
            scene.add(gridHelper);
        }

        /**
         * 创建标签
         * 为每个球体创建HTML标签显示材质名称和参数
         */
        function createLabels() {
            // 定义标签内容
            const labels = [
                { text: '清漆\nclearcoat=1', position: { x: -4, y: 2.5, z: 0 } },
                { text: '玻璃\ntransmission=1', position: { x: -2, y: 2.5, z: 0 } },
                { text: '绒布\nsheen=1', position: { x: 0, y: 2.5, z: 0 } },
                { text: '彩虹\niridescence=1', position: { x: 2, y: 2.5, z: 0 } },
                { text: '各向异性\nanisotropy=1', position: { x: 4, y: 2.5, z: 0 } }
            ];

            // 为每个标签创建div元素
            labels.forEach(label => {
                const div = document.createElement('div');
                div.className = 'material-label';
                div.innerHTML = label.text;
                div.style.left = '50%';
                div.style.top = '50%';
                div.style.transform = 'translate(-50%, -50%)';
                div.style.whiteSpace = 'pre-line';  // 保留换行符
                div.style.textAlign = 'center';
                div.style.lineHeight = '1.3';
                document.body.appendChild(div);
                label.element = div;  // 保存div引用
            });

            // 将标签数组存储到window对象，便于后续更新
            window.materialLabels = labels;
        }

        /**
         * 更新标签位置
         * 将3D坐标转换为2D屏幕坐标
         */
        function updateLabels() {
            if (!window.materialLabels) return;

            // 遍历所有标签
            window.materialLabels.forEach(label => {
                // 将3D位置转换为向量
                const vector = new THREE.Vector3(label.position.x, label.position.y, label.position.z);
                // 投影到标准化设备坐标(NDC)
                vector.project(camera);

                // 将NDC坐标转换为屏幕像素坐标
                const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                const y = (-(vector.y * 0.5) + 0.5) * window.innerHeight;

                // 只显示在相机视野内的标签
                if (vector.z < 1) {
                    label.element.style.display = 'block';
                    label.element.style.left = `${x}px`;
                    label.element.style.top = `${y}px`;
                } else {
                    label.element.style.display = 'none';
                }
            });
        }

        /**
         * 设置控制面板
         * 为材质参数添加交互控制
         */
        function setupControls() {
            // 获取DOM元素
            const clearcoatSlider = document.getElementById('clearcoat');
            const clearcoatRoughnessSlider = document.getElementById('clearcoatRoughness');
            const transmissionSlider = document.getElementById('transmission');
            const thicknessSlider = document.getElementById('thickness');
            const iorSlider = document.getElementById('ior');
            const sheenSlider = document.getElementById('sheen');
            const iridescenceSlider = document.getElementById('iridescence');
            const anisotropySlider = document.getElementById('anisotropy');
            const anisotropyRotationSlider = document.getElementById('anisotropyRotation');

            const clearcoatValue = document.getElementById('clearcoatValue');
            const clearcoatRoughnessValue = document.getElementById('clearcoatRoughnessValue');
            const transmissionValue = document.getElementById('transmissionValue');
            const thicknessValue = document.getElementById('thicknessValue');
            const iorValue = document.getElementById('iorValue');
            const sheenValue = document.getElementById('sheenValue');
            const iridescenceValue = document.getElementById('iridescenceValue');
            const anisotropyValue = document.getElementById('anisotropyValue');
            const anisotropyRotationValue = document.getElementById('anisotropyRotationValue');

            // 清漆强度滑块事件
            clearcoatSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                clearcoatValue.textContent = value.toFixed(2);
                if (currentMaterial) {
                    currentMaterial.clearcoat = value;  // 更新清漆强度
                }
            });

            // 清漆粗糙度滑块事件
            clearcoatRoughnessSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                clearcoatRoughnessValue.textContent = value.toFixed(2);
                if (currentMaterial) {
                    currentMaterial.clearcoatRoughness = value;  // 更新清漆粗糙度
                }
            });

            // 透射率滑块事件
            transmissionSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                transmissionValue.textContent = value.toFixed(2);
                if (currentMaterial) {
                    currentMaterial.transmission = value;  // 更新透射率
                }
            });

            // 厚度滑块事件
            thicknessSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                thicknessValue.textContent = value.toFixed(2);
                if (currentMaterial) {
                    currentMaterial.thickness = value;  // 更新材质厚度
                }
            });

            // 折射率滑块事件
            iorSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                iorValue.textContent = value.toFixed(3);
                if (currentMaterial) {
                    currentMaterial.ior = value;  // 更新折射率
                }
            });

            // 绒布强度滑块事件
            sheenSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                sheenValue.textContent = value.toFixed(2);
                if (currentMaterial) {
                    currentMaterial.sheen = value;  // 更新绒布强度
                }
            });

            // 彩虹强度滑块事件
            iridescenceSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                iridescenceValue.textContent = value.toFixed(2);
                if (currentMaterial) {
                    currentMaterial.iridescence = value;  // 更新彩虹强度
                }
            });

            // 各向异性滑块事件
            anisotropySlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                anisotropyValue.textContent = value.toFixed(2);
                if (currentMaterial) {
                    currentMaterial.anisotropy = value;  // 更新各向异性强度
                }
            });

            // 各向异性旋转滑块事件
            anisotropyRotationSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                anisotropyRotationValue.textContent = value.toFixed(2);
                if (currentMaterial) {
                    currentMaterial.anisotropyRotation = value;  // 更新各向异性旋转角度
                }
            });

            // 为每个球体添加点击事件
            spheres.forEach((sphere, index) => {
                sphere.addEventListener('click', () => {
                    // 切换当前材质
                    currentMaterial = sphere.material;
                    // 更新所有滑块值
                    clearcoatSlider.value = sphere.material.clearcoat || 0;
                    clearcoatValue.textContent = (sphere.material.clearcoat || 0).toFixed(2);
                    clearcoatRoughnessSlider.value = sphere.material.clearcoatRoughness || 0;
                    clearcoatRoughnessValue.textContent = (sphere.material.clearcoatRoughness || 0).toFixed(2);
                    transmissionSlider.value = sphere.material.transmission || 0;
                    transmissionValue.textContent = (sphere.material.transmission || 0).toFixed(2);
                    thicknessSlider.value = sphere.material.thickness || 0;
                    thicknessValue.textContent = (sphere.material.thickness || 0).toFixed(2);
                    iorSlider.value = sphere.material.ior || 1.5;
                    iorValue.textContent = (sphere.material.ior || 1.5).toFixed(3);
                    sheenSlider.value = sphere.material.sheen || 0;
                    sheenValue.textContent = (sphere.material.sheen || 0).toFixed(2);
                    iridescenceSlider.value = sphere.material.iridescence || 0;
                    iridescenceValue.textContent = (sphere.material.iridescence || 0).toFixed(2);
                    anisotropySlider.value = sphere.material.anisotropy || 0;
                    anisotropyValue.textContent = (sphere.material.anisotropy || 0).toFixed(2);
                    anisotropyRotationSlider.value = sphere.material.anisotropyRotation || 0;
                    anisotropyRotationValue.textContent = (sphere.material.anisotropyRotation || 0).toFixed(2);
                });
            });
        }

        /**
         * 窗口大小变化处理
         * 更新相机和渲染器参数
         */
        function onWindowResize() {
            // 更新相机宽高比
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            // 更新渲染器尺寸
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        /**
         * 动画循环
         * 每帧更新场景并渲染
         */
        function animate() {
            requestAnimationFrame(animate);  // 请求下一帧

            // 获取当前时间(秒)
            const time = Date.now() * 0.001;

            // 更新每个球体的位置和旋转
            spheres.forEach((sphere, index) => {
                // 上下浮动动画 - 每个球体有相位差
                sphere.position.y = 1 + Math.sin(time + index * 0.5) * 0.2;
                // 旋转动画
                sphere.rotation.y = time * 0.3;
            });

            // 更新控制器
            controls.update();
            // 更新标签位置
            updateLabels();
            // 渲染场景
            renderer.render(scene, camera);
        }

        // 启动程序
        init();
    </script>
</body>
</html>
